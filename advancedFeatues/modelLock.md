# Блокировка модели

Optimacros предусматривает четыре уровня блокировки модели: `shared lock`, `unique lock`, `custom lock` и `complete lock`. В рамках настоящего описания под пользователями модели подразумеваются все, кто к ней обращается: и люди, и скрипты, и приложения.

`Shared lock` – режим, не предполагающий изменение метаданных модели. В этом режиме можно читать данные модели и модифицировать данные (но не метаданные), запускать другие скрипты. Нет ограничения на количество пользователей.

`Unique lock` – режим, который включается непосредственно перед модификацией метаданных (например, обновлением системных колонок справочников, добавлением/удалением элементов или самих справочников/мультикубов). Одновременно в этом режиме может существовать только один пользователь, при этом пользователи в режиме `shared lock` могут продолжать свою работу, поскольку модификация метаданных в Optimacros построена на транзакционном подходе. Непосредственно перед завершением (commit) транзакции уровень блокировки меняется на `complete lock`.

`Custom lock` — режим, при котором пользователь находится вне контекста модели и не может с ней взаимодействовать.

`Complete lock` – режим, при котором блокируются все пользователи. Этот режим невозможно установить.

Во вкладке `Макросы` -> `Скрипты` в столбце `Lock Mode` для каждого скрипта можно установить начальный максимальный режим блокировки. Кроме того, скрипт может  в процессе работы поменять себе этот режим функциями интерфейса [`ModelInfo`](../API/common.md#model-info). Режим `custom lock` вызывается функцией `ModelInfo`.[`unlock()`](../API/common.md#model-info.unlock). При переключении блокировки скрипт будет ждать, когда Optimacros ему её предоставит. При этом существует тайм-аут, и если блокировку не получится выделить в течение некоторого времени, будет выброшено исключение вида `Unique lock not found`. 

Установленный режим не означает, что модель будет заблокирована на всё время работы скрипта: модель будет блокироваться только на время выполнения конкретной операции. При этом скрипт встанет в общую очередь с другими пользователями, и во вспывающем окне (или в разделе Requests админки) появится сообщение:

* `Waiting to lock the model` — скрипт ждёт, когда все операции до него пройдут, чтобы монопольно заблокировать модель для модификации метаданных.
* `Waiting to lock the workspace` — скрипт ждёт, когда сможет заблокировать весь воркспейс (требуется, например, для удаления сабсетов справочника версий).

Во время работы скрипта в режимах `shared lock` и `unique lock` если скрипт не совершает действий, блокирующих модель, пользователи могут модифицировать данные (клетки кубов), но для модификации метаданных понадобится монопольная блокировка модели и придётся ждать, пока скрипт закончит работу.

При модификации метаданных скрипт переходит в режим `unique lock` и находится в нём либо до завершения (commit), либо до отката (rollback) транзакции. Перед завершением транзакции скрипт переходит в режим `complete lock`, а после завершения – в `shared lock`. В случае отката транзакции скрипт сразу возвращается в режим `shared lock`. В режимах `shared lock` и `custom lock` разные скрипты могут работать параллельно. 

Такое устройство системы блокировок означает, что модели Optimacros позволяют эффективно многократно модифицировать данные мультикубов, не блокируя других пользователей. Тем не менее, для ускорения множества таких операций рекомендуется группировать их, например, с помощью [`CellBuffer`](../API/common.md#cell-buffer), импорта из [`файла CSV`](../API/exportImport.md#import) или из [`базы данных`](../API/relationalDB.md#db-import). Однако при многократной модификации метаданных, другие пользователи модели будут также многократно блокироваться. Поэтому особенно важно при проектировании скриптов предусмотреть группировку операций, в частности [добавления](../API/elementsManipulator.md#elements-creator), [удаления](../API/elementsManipulator.md#elements-deleter) или [тасования](../API/elementsManipulator.md#elements-reorder) элементов в справочниках.

## Параллельный запуск скриптов

Скрипты могут работать параллельно:

* при запуске с разных вкладок (в том числе одним пользователем)
* при запуске через API воркспейса
* при запуске по расписанию

При этом 

* скрипыт с `custom lock` и `shared lock` могут работать параллельно таким же и скрипту в режиме `unique lock`
* два скрипта в режиме `unique lock` параллельно работать не могут, один будет ждать, пока блокировка `unique lock` освободится
* при выполнении конкретных операций возможность параллельного выполнения этих операций определяется как и для обычных пользователей.

[Расширенные возможности](advancedFeatues.md)

[Оглавление](../README.md)
